#!/bin/bash

set -aex

input_file=$1
grid_file=$2
output_file=$3

# NOTE(mgnb): Sorry for this mess. After the conservative remapping, pick the
# region with the largest portion of the regrid. Break ties into lower-numbered
# regions.
cdo \
    -w \
    -expr,'
        Region00 = Region00 > 0 && Region00 >= Region00 && Region00 >= Region01 && Region00 >= Region02 && Region00 >= Region03 && Region00 >= Region04 && Region00 >= Region05 && Region00 >= Region06 && Region00 >= Region07 && Region00 >= Region08 && Region00 >= Region09 && Region00 >= Region10 && Region00 >= Region11 && Region00 >= Region12 && Region00 >= Region13 && Region00 >= Region14 && Region00 >= Region15 && Region00 >= Region16 && Region00 >= Region17 && Region00 >= Region18 && Region00 >= Region19 && Region00 >= Region20 && Region00 >= Region21 && Region00 >= Region22;
        Region01 = Region01 > 0 && Region01 >  Region00 && Region01 >= Region01 && Region01 >= Region02 && Region01 >= Region03 && Region01 >= Region04 && Region01 >= Region05 && Region01 >= Region06 && Region01 >= Region07 && Region01 >= Region08 && Region01 >= Region09 && Region01 >= Region10 && Region01 >= Region11 && Region01 >= Region12 && Region01 >= Region13 && Region01 >= Region14 && Region01 >= Region15 && Region01 >= Region16 && Region01 >= Region17 && Region01 >= Region18 && Region01 >= Region19 && Region01 >= Region20 && Region01 >= Region21 && Region01 >= Region22;
        Region02 = Region02 > 0 && Region02 >  Region00 && Region02 >  Region01 && Region02 >= Region02 && Region02 >= Region03 && Region02 >= Region04 && Region02 >= Region05 && Region02 >= Region06 && Region02 >= Region07 && Region02 >= Region08 && Region02 >= Region09 && Region02 >= Region10 && Region02 >= Region11 && Region02 >= Region12 && Region02 >= Region13 && Region02 >= Region14 && Region02 >= Region15 && Region02 >= Region16 && Region02 >= Region17 && Region02 >= Region18 && Region02 >= Region19 && Region02 >= Region20 && Region02 >= Region21 && Region02 >= Region22;
        Region03 = Region03 > 0 && Region03 >  Region00 && Region03 >  Region01 && Region03 >  Region02 && Region03 >= Region03 && Region03 >= Region04 && Region03 >= Region05 && Region03 >= Region06 && Region03 >= Region07 && Region03 >= Region08 && Region03 >= Region09 && Region03 >= Region10 && Region03 >= Region11 && Region03 >= Region12 && Region03 >= Region13 && Region03 >= Region14 && Region03 >= Region15 && Region03 >= Region16 && Region03 >= Region17 && Region03 >= Region18 && Region03 >= Region19 && Region03 >= Region20 && Region03 >= Region21 && Region03 >= Region22;
        Region04 = Region04 > 0 && Region04 >  Region00 && Region04 >  Region01 && Region04 >  Region02 && Region04 >  Region03 && Region04 >= Region04 && Region04 >= Region05 && Region04 >= Region06 && Region04 >= Region07 && Region04 >= Region08 && Region04 >= Region09 && Region04 >= Region10 && Region04 >= Region11 && Region04 >= Region12 && Region04 >= Region13 && Region04 >= Region14 && Region04 >= Region15 && Region04 >= Region16 && Region04 >= Region17 && Region04 >= Region18 && Region04 >= Region19 && Region04 >= Region20 && Region04 >= Region21 && Region04 >= Region22;
        Region05 = Region05 > 0 && Region05 >  Region00 && Region05 >  Region01 && Region05 >  Region02 && Region05 >  Region03 && Region05 >  Region04 && Region05 >= Region05 && Region05 >= Region06 && Region05 >= Region07 && Region05 >= Region08 && Region05 >= Region09 && Region05 >= Region10 && Region05 >= Region11 && Region05 >= Region12 && Region05 >= Region13 && Region05 >= Region14 && Region05 >= Region15 && Region05 >= Region16 && Region05 >= Region17 && Region05 >= Region18 && Region05 >= Region19 && Region05 >= Region20 && Region05 >= Region21 && Region05 >= Region22;
        Region06 = Region06 > 0 && Region06 >  Region00 && Region06 >  Region01 && Region06 >  Region02 && Region06 >  Region03 && Region06 >  Region04 && Region06 >  Region05 && Region06 >= Region06 && Region06 >= Region07 && Region06 >= Region08 && Region06 >= Region09 && Region06 >= Region10 && Region06 >= Region11 && Region06 >= Region12 && Region06 >= Region13 && Region06 >= Region14 && Region06 >= Region15 && Region06 >= Region16 && Region06 >= Region17 && Region06 >= Region18 && Region06 >= Region19 && Region06 >= Region20 && Region06 >= Region21 && Region06 >= Region22;
        Region07 = Region07 > 0 && Region07 >  Region00 && Region07 >  Region01 && Region07 >  Region02 && Region07 >  Region03 && Region07 >  Region04 && Region07 >  Region05 && Region07 >  Region06 && Region07 >= Region07 && Region07 >= Region08 && Region07 >= Region09 && Region07 >= Region10 && Region07 >= Region11 && Region07 >= Region12 && Region07 >= Region13 && Region07 >= Region14 && Region07 >= Region15 && Region07 >= Region16 && Region07 >= Region17 && Region07 >= Region18 && Region07 >= Region19 && Region07 >= Region20 && Region07 >= Region21 && Region07 >= Region22;
        Region08 = Region08 > 0 && Region08 >  Region00 && Region08 >  Region01 && Region08 >  Region02 && Region08 >  Region03 && Region08 >  Region04 && Region08 >  Region05 && Region08 >  Region06 && Region08 >  Region07 && Region08 >= Region08 && Region08 >= Region09 && Region08 >= Region10 && Region08 >= Region11 && Region08 >= Region12 && Region08 >= Region13 && Region08 >= Region14 && Region08 >= Region15 && Region08 >= Region16 && Region08 >= Region17 && Region08 >= Region18 && Region08 >= Region19 && Region08 >= Region20 && Region08 >= Region21 && Region08 >= Region22;
        Region09 = Region09 > 0 && Region09 >  Region00 && Region09 >  Region01 && Region09 >  Region02 && Region09 >  Region03 && Region09 >  Region04 && Region09 >  Region05 && Region09 >  Region06 && Region09 >  Region07 && Region09 >  Region08 && Region09 >= Region09 && Region09 >= Region10 && Region09 >= Region11 && Region09 >= Region12 && Region09 >= Region13 && Region09 >= Region14 && Region09 >= Region15 && Region09 >= Region16 && Region09 >= Region17 && Region09 >= Region18 && Region09 >= Region19 && Region09 >= Region20 && Region09 >= Region21 && Region09 >= Region22;
        Region10 = Region10 > 0 && Region10 >  Region00 && Region10 >  Region01 && Region10 >  Region02 && Region10 >  Region03 && Region10 >  Region04 && Region10 >  Region05 && Region10 >  Region06 && Region10 >  Region07 && Region10 >  Region08 && Region10 >  Region09 && Region10 >= Region10 && Region10 >= Region11 && Region10 >= Region12 && Region10 >= Region13 && Region10 >= Region14 && Region10 >= Region15 && Region10 >= Region16 && Region10 >= Region17 && Region10 >= Region18 && Region10 >= Region19 && Region10 >= Region20 && Region10 >= Region21 && Region10 >= Region22;
        Region11 = Region11 > 0 && Region11 >  Region00 && Region11 >  Region01 && Region11 >  Region02 && Region11 >  Region03 && Region11 >  Region04 && Region11 >  Region05 && Region11 >  Region06 && Region11 >  Region07 && Region11 >  Region08 && Region11 >  Region09 && Region11 >  Region10 && Region11 >= Region11 && Region11 >= Region12 && Region11 >= Region13 && Region11 >= Region14 && Region11 >= Region15 && Region11 >= Region16 && Region11 >= Region17 && Region11 >= Region18 && Region11 >= Region19 && Region11 >= Region20 && Region11 >= Region21 && Region11 >= Region22;
        Region12 = Region12 > 0 && Region12 >  Region00 && Region12 >  Region01 && Region12 >  Region02 && Region12 >  Region03 && Region12 >  Region04 && Region12 >  Region05 && Region12 >  Region06 && Region12 >  Region07 && Region12 >  Region08 && Region12 >  Region09 && Region12 >  Region10 && Region12 >  Region11 && Region12 >= Region12 && Region12 >= Region13 && Region12 >= Region14 && Region12 >= Region15 && Region12 >= Region16 && Region12 >= Region17 && Region12 >= Region18 && Region12 >= Region19 && Region12 >= Region20 && Region12 >= Region21 && Region12 >= Region22;
        Region13 = Region13 > 0 && Region13 >  Region00 && Region13 >  Region01 && Region13 >  Region02 && Region13 >  Region03 && Region13 >  Region04 && Region13 >  Region05 && Region13 >  Region06 && Region13 >  Region07 && Region13 >  Region08 && Region13 >  Region09 && Region13 >  Region10 && Region13 >  Region11 && Region13 >  Region12 && Region13 >= Region13 && Region13 >= Region14 && Region13 >= Region15 && Region13 >= Region16 && Region13 >= Region17 && Region13 >= Region18 && Region13 >= Region19 && Region13 >= Region20 && Region13 >= Region21 && Region13 >= Region22;
        Region14 = Region14 > 0 && Region14 >  Region00 && Region14 >  Region01 && Region14 >  Region02 && Region14 >  Region03 && Region14 >  Region04 && Region14 >  Region05 && Region14 >  Region06 && Region14 >  Region07 && Region14 >  Region08 && Region14 >  Region09 && Region14 >  Region10 && Region14 >  Region11 && Region14 >  Region12 && Region14 >  Region13 && Region14 >= Region14 && Region14 >= Region15 && Region14 >= Region16 && Region14 >= Region17 && Region14 >= Region18 && Region14 >= Region19 && Region14 >= Region20 && Region14 >= Region21 && Region14 >= Region22;
        Region15 = Region15 > 0 && Region15 >  Region00 && Region15 >  Region01 && Region15 >  Region02 && Region15 >  Region03 && Region15 >  Region04 && Region15 >  Region05 && Region15 >  Region06 && Region15 >  Region07 && Region15 >  Region08 && Region15 >  Region09 && Region15 >  Region10 && Region15 >  Region11 && Region15 >  Region12 && Region15 >  Region13 && Region15 >  Region14 && Region15 >= Region15 && Region15 >= Region16 && Region15 >= Region17 && Region15 >= Region18 && Region15 >= Region19 && Region15 >= Region20 && Region15 >= Region21 && Region15 >= Region22;
        Region16 = Region16 > 0 && Region16 >  Region00 && Region16 >  Region01 && Region16 >  Region02 && Region16 >  Region03 && Region16 >  Region04 && Region16 >  Region05 && Region16 >  Region06 && Region16 >  Region07 && Region16 >  Region08 && Region16 >  Region09 && Region16 >  Region10 && Region16 >  Region11 && Region16 >  Region12 && Region16 >  Region13 && Region16 >  Region14 && Region16 >  Region15 && Region16 >= Region16 && Region16 >= Region17 && Region16 >= Region18 && Region16 >= Region19 && Region16 >= Region20 && Region16 >= Region21 && Region16 >= Region22;
        Region17 = Region17 > 0 && Region17 >  Region00 && Region17 >  Region01 && Region17 >  Region02 && Region17 >  Region03 && Region17 >  Region04 && Region17 >  Region05 && Region17 >  Region06 && Region17 >  Region07 && Region17 >  Region08 && Region17 >  Region09 && Region17 >  Region10 && Region17 >  Region11 && Region17 >  Region12 && Region17 >  Region13 && Region17 >  Region14 && Region17 >  Region15 && Region17 >  Region16 && Region17 >= Region17 && Region17 >= Region18 && Region17 >= Region19 && Region17 >= Region20 && Region17 >= Region21 && Region17 >= Region22;
        Region18 = Region18 > 0 && Region18 >  Region00 && Region18 >  Region01 && Region18 >  Region02 && Region18 >  Region03 && Region18 >  Region04 && Region18 >  Region05 && Region18 >  Region06 && Region18 >  Region07 && Region18 >  Region08 && Region18 >  Region09 && Region18 >  Region10 && Region18 >  Region11 && Region18 >  Region12 && Region18 >  Region13 && Region18 >  Region14 && Region18 >  Region15 && Region18 >  Region16 && Region18 >  Region17 && Region18 >= Region18 && Region18 >= Region19 && Region18 >= Region20 && Region18 >= Region21 && Region18 >= Region22;
        Region19 = Region19 > 0 && Region19 >  Region00 && Region19 >  Region01 && Region19 >  Region02 && Region19 >  Region03 && Region19 >  Region04 && Region19 >  Region05 && Region19 >  Region06 && Region19 >  Region07 && Region19 >  Region08 && Region19 >  Region09 && Region19 >  Region10 && Region19 >  Region11 && Region19 >  Region12 && Region19 >  Region13 && Region19 >  Region14 && Region19 >  Region15 && Region19 >  Region16 && Region19 >  Region17 && Region19 >  Region18 && Region19 >= Region19 && Region19 >= Region20 && Region19 >= Region21 && Region19 >= Region22;
        Region20 = Region20 > 0 && Region20 >  Region00 && Region20 >  Region01 && Region20 >  Region02 && Region20 >  Region03 && Region20 >  Region04 && Region20 >  Region05 && Region20 >  Region06 && Region20 >  Region07 && Region20 >  Region08 && Region20 >  Region09 && Region20 >  Region10 && Region20 >  Region11 && Region20 >  Region12 && Region20 >  Region13 && Region20 >  Region14 && Region20 >  Region15 && Region20 >  Region16 && Region20 >  Region17 && Region20 >  Region18 && Region20 >  Region19 && Region20 >= Region20 && Region20 >= Region21 && Region20 >= Region22;
        Region21 = Region21 > 0 && Region21 >  Region00 && Region21 >  Region01 && Region21 >  Region02 && Region21 >  Region03 && Region21 >  Region04 && Region21 >  Region05 && Region21 >  Region06 && Region21 >  Region07 && Region21 >  Region08 && Region21 >  Region09 && Region21 >  Region10 && Region21 >  Region11 && Region21 >  Region12 && Region21 >  Region13 && Region21 >  Region14 && Region21 >  Region15 && Region21 >  Region16 && Region21 >  Region17 && Region21 >  Region18 && Region21 >  Region19 && Region21 >  Region20 && Region21 >= Region21 && Region21 >= Region22;
        Region22 = Region22 > 0 && Region22 >  Region00 && Region22 >  Region01 && Region22 >  Region02 && Region22 >  Region03 && Region22 >  Region04 && Region22 >  Region05 && Region22 >  Region06 && Region22 >  Region07 && Region22 >  Region08 && Region22 >  Region09 && Region22 >  Region10 && Region22 >  Region11 && Region22 >  Region12 && Region22 >  Region13 && Region22 >  Region14 && Region22 >  Region15 && Region22 >  Region16 && Region22 >  Region17 && Region22 >  Region18 && Region22 >  Region19 && Region22 >  Region20 && Region22 >  Region21 && Region22 >= Region22;
    ' \
    -remapcon,${grid_file} \
    -expr,'
        Region00 = mask64 == 0;
        Region01 = mask64 == 1;
        Region02 = mask64 == 2;
        Region03 = mask64 == 3;
        Region04 = mask64 == 4;
        Region05 = mask64 == 5;
        Region06 = mask64 == 6;
        Region07 = mask64 == 7;
        Region08 = mask64 == 8;
        Region09 = mask64 == 9;
        Region10 = mask64 == 10;
        Region11 = mask64 == 11;
        Region12 = mask64 == 12;
        Region13 = mask64 == 13;
        Region14 = mask64 == 14;
        Region15 = mask64 == 15;
        Region16 = mask64 == 16;
        Region17 = mask64 == 17;
        Region18 = mask64 == 18;
        Region19 = mask64 == 19;
        Region20 = mask64 == 20;
        Region21 = mask64 == 21;
        Region22 = mask64 == 22;
    ' \
    $input_file \
    $output_file
